import React, { useMemo, useRef, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, LabelList } from "recharts";
import { Calendar, Calculator, Download, GitBranch, Layers } from "lucide-react";
import jsPDF from "jspdf";
import html2canvas from "html2canvas";

// --------------------
// Helpers & Constants
// --------------------
const months = ["Nov 2025","Dec 2025","Jan 2026","Feb 2026","Mar 2026","Apr 2026","May 2026","Jun 2026"]; // Year‑1 launch window
const startBase = new Date("2025-11-01T00:00:00");
const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
const toIdx = (iso) => clamp(((new Date(iso+"T00:00:00").getFullYear()-startBase.getFullYear())*12) + (new Date(iso+"T00:00:00").getMonth()-startBase.getMonth()),0,7);
const span = (sISO, eISO) => Math.max(1, toIdx(eISO) - toIdx(sISO) + 1);
const fmt1 = (v) => (isFinite(v) ? Number(v).toFixed(1) : "—"); // 1 decimal everywhere

// --------------------
// Color Key
// --------------------
const COLORS = { Compliance: "#E53935", Infra: "#7E57C2", Academic: "#1E88E5", Tech: "#43A047", Marketing: "#FB8C00" };

// --------------------
// Year‑1 Very‑Detailed Tasks
// --------------------
const TASKS = [
  { task: "Affiliation Application Filed", start: "2025-09-01", end: "2026-01-31", cat: "Compliance", owner: "Compliance Advisor" },
  { task: "Affiliation Approval & NOC", start: "2026-02-01", end: "2026-05-31", cat: "Compliance", owner: "Compliance Advisor" },
  { task: "Campus Lease & Deposit", start: "2026-01-01", end: "2026-01-31", cat: "Infra", owner: "COO" },
  { task: "Fit‑out & Interiors", start: "2026-02-01", end: "2026-05-15", cat: "Infra", owner: "COO" },
  { task: "Lab Setup & Furniture", start: "2026-03-01", end: "2026-05-31", cat: "Infra", owner: "COO" },
  { task: "IT/CBT Infra Installation", start: "2026-04-01", end: "2026-05-31", cat: "Infra", owner: "COO" },
  { task: "Curriculum Map (IPE + JEE/NEET)", start: "2025-12-01", end: "2026-02-15", cat: "Academic", owner: "Academic Director" },
  { task: "Core Faculty Hiring (PCM+B)", start: "2026-02-01", end: "2026-03-31", cat: "Academic", owner: "Academic Director" },
  { task: "Faculty Induction & Pedagogy", start: "2026-04-01", end: "2026-05-15", cat: "Academic", owner: "Academic Director" },
  { task: "Mentors & TAs Hiring", start: "2026-04-01", end: "2026-05-31", cat: "Academic", owner: "Academic Director" },
  { task: "App MVP (Practice Engine)", start: "2025-11-01", end: "2026-01-31", cat: "Tech", owner: "EdTech PM" },
  { task: "Leaderboard & Rank Predictor", start: "2026-01-01", end: "2026-03-31", cat: "Tech", owner: "EdTech PM" },
  { task: "CBT Module Integration", start: "2026-04-01", end: "2026-06-15", cat: "Tech", owner: "EdTech PM" },
  { task: "Marketing Microsite Launch", start: "2025-12-01", end: "2026-01-15", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "Scholarship Test #1 (Online)", start: "2026-01-15", end: "2026-01-31", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "School Seminars & Outreach", start: "2026-02-01", end: "2026-03-31", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "Parent Counselling Sessions", start: "2026-03-01", end: "2026-05-31", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "Scholarship Test #2 (Offline)", start: "2026-04-01", end: "2026-04-15", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "Admissions Finalization", start: "2026-04-01", end: "2026-05-31", cat: "Marketing", owner: "Sales & Marketing Head" },
  { task: "Orientation (Parents & Students)", start: "2026-06-01", end: "2026-06-07", cat: "Academic", owner: "Academic Director" },
  { task: "Classes Commence", start: "2026-06-08", end: "2026-06-30", cat: "Academic", owner: "Academic Director" },
];

// --------------------
// Finance Utils (Lakhs)
// --------------------
const irr = (cfs, guess = 0.2) => {
  let r = guess;
  for (let i = 0; i < 60; i++) {
    let npv = 0, d = 0;
    for (let t = 0; t < cfs.length; t++) { npv += cfs[t] / Math.pow(1 + r, t); d += (-t * cfs[t]) / Math.pow(1 + r, t + 1); }
    const nr = r - npv / d; if (!isFinite(nr)) break; if (Math.abs(nr - r) < 1e-7) return r; r = Math.max(-0.99, nr);
  }
  return r;
};

const metrics = ({students, fee, scholarshipPct, variable, fixed, capex, growth}) => {
  const netFee = fee * (1 - scholarshipPct/100);
  const grossRevenue = fee * students;
  const netRevenue = netFee * students;
  const variableCosts = variable * students;
  const totalExpenses = fixed + variableCosts;
  const profit = netRevenue - totalExpenses;
  const margin = netRevenue > 0 ? (profit/netRevenue)*100 : 0;
  const contribution = netFee - variable;
  const be = contribution > 0 ? Math.ceil(fixed / contribution) : Infinity;
  const roi = capex>0? (profit/capex)*100 : 0;
  const payback = profit>0? (capex/profit) : Infinity;
  const p1 = profit, p2 = profit*(1+growth/100), p3 = p2*(1+growth/100);
  const irrPct = irr([-capex, p1, p2, p3]) * 100;
  return {netFee,grossRevenue,netRevenue,variableCosts,totalExpenses,profit,margin,contribution,be,roi,payback,irrPct};
};

export default function LaunchControl() {
  // Inputs (Lakhs)
  const [students, setStudents] = useState(200);
  const [fee, setFee] = useState(1.05);
  const [scholarshipPct, setScholarshipPct] = useState(5);
  const [variablePerStudent, setVariablePerStudent] = useState(0.10);
  const [fixedOpex, setFixedOpex] = useState(150);
  const [capex, setCapex] = useState(150);
  const [growth, setGrowth] = useState(20);
  const [scaleFixed, setScaleFixed] = useState(false); // scale fixed OPEX with scenario size?

  const containerRef = useRef(null);

  const applyPreset = (name) => {
    if (name === "Lean 1.5 Cr") { setFixedOpex(150); setFee(1.05); setVariablePerStudent(0.10); setScholarshipPct(5); }
    if (name === "PDF 2.1 Cr") { setFixedOpex(210); setFee(1.20); setVariablePerStudent(0.20); setScholarshipPct(5); }
  };

  // Base metrics
  const base = useMemo(() => metrics({students, fee, scholarshipPct, variable: variablePerStudent, fixed: fixedOpex, capex, growth}), [students, fee, scholarshipPct, variablePerStudent, fixedOpex, capex, growth]);

  // Scenario metrics
  const scenStudents = [120, 200, 300];
  const scenData = scenStudents.map((s) => {
    const fixed = scaleFixed ? fixedOpex * (s / students) : fixedOpex; // optional scaling
    const m = metrics({students: s, fee, scholarshipPct, variable: variablePerStudent, fixed, capex, growth});
    return { Scenario: `${s} students`, Students: s, Revenue: m.netRevenue, Expenses: m.totalExpenses, Profit: m.profit, Margin: m.margin, BE: m.be, ROI: m.roi, IRR: m.irrPct };
  });

  const budgetBreakdown = [
    { name: "Fixed OPEX", value: fixedOpex },
    { name: "Variable (total)", value: base.variableCosts },
  ];

  const exportPNG = async () => {
    if (!containerRef.current) return;
    const canvas = await html2canvas(containerRef.current, { scale: 2, backgroundColor: "#ffffff" });
    const data = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = data; a.download = `Launch-Control-${Date.now()}.png`; a.click();
  };

  const exportPDF = async () => {
    if (!containerRef.current) return;
    const canvas = await html2canvas(containerRef.current, { scale: 2, backgroundColor: "#ffffff" });
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF({ orientation: "landscape", unit: "px", format: [canvas.width, canvas.height] });
    pdf.addImage(imgData, "PNG", 0, 0, canvas.width, canvas.height);
    pdf.save(`Launch-Control-${Date.now()}.pdf`);
  };

  return (
    <div className="w-full p-4 space-y-6" ref={containerRef}>
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Launch Control Center — Year‑1 Gantt & Financials</h1>
        <div className="flex gap-2">
          <Button onClick={exportPNG} className="rounded-2xl"><Download className="w-4 h-4 mr-2"/>Export PNG</Button>
          <Button variant="secondary" onClick={exportPDF} className="rounded-2xl"><Download className="w-4 h-4 mr-2"/>Export PDF</Button>
        </div>
      </div>

      {/* Presets */}
      <div className="flex gap-2">
        <Button className="rounded-2xl" onClick={() => applyPreset("Lean 1.5 Cr")}>Preset: Lean ₹1.5 Cr</Button>
        <Button variant="secondary" className="rounded-2xl" onClick={() => applyPreset("PDF 2.1 Cr")}>Preset: PDF ₹2.1 Cr</Button>
      </div>

      {/* Inputs */}
      <Card className="shadow-sm border">
        <CardContent className="p-4 grid md:grid-cols-3 gap-4">
          <div className="space-y-2">
            <label className="text-sm">Students</label>
            <Input type="number" value={students} onChange={(e)=>setStudents(parseInt(e.target.value||"0"))} />
            <label className="text-sm">Fee per Student (₹ Lakhs)</label>
            <Input type="number" step="0.01" value={fee} onChange={(e)=>setFee(parseFloat(e.target.value||"0"))} />
            <label className="text-sm">Scholarship / Discount (%)</label>
            <Input type="number" step="1" value={scholarshipPct} onChange={(e)=>setScholarshipPct(parseFloat(e.target.value||"0"))} />
          </div>
          <div className="space-y-2">
            <label className="text-sm">Variable Cost per Student (₹ Lakhs)</label>
            <Input type="number" step="0.01" value={variablePerStudent} onChange={(e)=>setVariablePerStudent(parseFloat(e.target.value||"0"))} />
            <label className="text-sm">Fixed Expenses (OPEX, ₹ Lakhs)</label>
            <Input type="number" step="1" value={fixedOpex} onChange={(e)=>setFixedOpex(parseFloat(e.target.value||"0"))} />
            <label className="text-sm">CapEx (₹ Lakhs)</label>
            <Input type="number" step="1" value={capex} onChange={(e)=>setCapex(parseFloat(e.target.value||"0"))} />
          </div>
          <div className="space-y-2">
            <label className="text-sm">IRR Growth Assumption (% YoY on profit)</label>
            <Input type="number" step="1" value={growth} onChange={(e)=>setGrowth(parseFloat(e.target.value||"0"))} />
            <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={scaleFixed} onChange={(e)=>setScaleFixed(e.target.checked)} />Scale fixed OPEX with scenario size</label>
            <div className="flex gap-2 pt-2">
              <Button className="rounded-2xl" onClick={()=>applyPreset("Lean 1.5 Cr")}>Lean</Button>
              <Button variant="secondary" className="rounded-2xl" onClick={()=>applyPreset("PDF 2.1 Cr")}>PDF</Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Gantt — cleaned using inline CSS grid placement */}
      <Card className="shadow-sm border">
        <CardContent className="p-4">
          <div className="flex items-center gap-2 mb-3"><Calendar className="w-5 h-5"/><h2 className="text-xl font-medium">Detailed Year‑1 Gantt (Color‑coded)</h2></div>
          <div className="grid grid-cols-8 text-xs text-muted-foreground mb-2">
            {months.map((m) => (<div key={m} className="text-center font-medium border-b pb-1">{m}</div>))}
          </div>
          <div className="space-y-1">
            {TASKS.map((t, idx) => {
              const s = toIdx(t.start) + 1; // 1-based
              const sp = span(t.start, t.end);
              return (
                <div key={idx} className="grid grid-cols-8 items-stretch h-8 border-b">
                  <div style={{gridColumnStart: s, gridColumnEnd: s + sp}} className="flex items-center">
                    <div className="w-full h-5 rounded-xl shadow flex items-center justify-between px-2 text-[11px] text-white" style={{backgroundColor: COLORS[t.cat]}}>
                      <span className="font-semibold truncate">{t.task}</span>
                      <span className="opacity-90 ml-2 truncate">{t.cat} • {t.owner}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          <div className="flex flex-wrap gap-3 mt-3">
            {Object.entries(COLORS).map(([k, v]) => (
              <div key={k} className="flex items-center gap-2 text-sm"><div className="w-4 h-4 rounded" style={{backgroundColor: v}}></div><span>{k}</span></div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Budget Snapshot */}
      <Card className="shadow-sm border">
        <CardContent className="p-4 space-y-4">
          <div className="flex items-center gap-2 mb-2"><Calculator className="w-5 h-5"/><h2 className="text-xl font-medium">Budget & ROI (₹ Lakhs, rounded to 1 decimal)</h2></div>

          <div className="grid md:grid-cols-4 gap-4">
            <Card className="bg-slate-50"><CardContent className="p-3"><div className="text-xs">Gross Revenue</div><div className="text-lg font-semibold">₹ {fmt1(base.grossRevenue)} L</div></CardContent></Card>
            <Card className="bg-slate-50"><CardContent className="p-3"><div className="text-xs">Net Revenue</div><div className="text-lg font-semibold">₹ {fmt1(base.netRevenue)} L</div></CardContent></Card>
            <Card className="bg-slate-50"><CardContent className="p-3"><div className="text-xs">Total Expenses</div><div className="text-lg font-semibold">₹ {fmt1(base.totalExpenses)} L</div></CardContent></Card>
            <Card className="bg-slate-50"><CardContent className="p-3"><div className="text-xs">Profit / (Loss)</div><div className={`text-lg font-semibold ${base.profit>=0?"text-emerald-700":"text-red-600"}`}>₹ {fmt1(base.profit)} L</div></CardContent></Card>
          </div>
          <div className="grid md:grid-cols-4 gap-4">
            <Card><CardContent className="p-3"><div className="text-xs">Profit Margin</div><div className="text-lg font-semibold">{fmt1(base.margin)}%</div></CardContent></Card>
            <Card><CardContent className="p-3"><div className="text-xs">Breakeven Students</div><div className="text-lg font-semibold">{base.be}</div><div className="text-xs text-muted-foreground">Contribution/student (net): ₹ {fmt1(base.contribution)} L</div></CardContent></Card>
            <Card><CardContent className="p-3"><div className="text-xs">Year‑1 ROI vs CapEx</div><div className="text-lg font-semibold">{fmt1(base.roi)}%</div></CardContent></Card>
            <Card><CardContent className="p-3"><div className="text-xs">Payback (years)</div><div className="text-lg font-semibold">{isFinite(base.payback)?fmt1(base.payback):"N/A"}</div></CardContent></Card>
          </div>

          <div className="grid md:grid-cols-2 gap-4 items-center">
            <div>
              <div className="flex items-center gap-2 mb-2"><GitBranch className="w-5 h-5"/><h3 className="font-medium">3‑Year IRR</h3></div>
              <div className="text-2xl font-semibold">{fmt1(base.irrPct)}%</div>
              <div className="text-xs text-muted-foreground">Cash flows: [−CapEx, Y1 Profit, Y2 Profit, Y3 Profit]</div>
            </div>
            <div className="h-44">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={[{name:"Fixed OPEX", value: fixedOpex},{name:"Variable (total)", value: base.variableCosts}]} margin={{ top: 8, right: 16, bottom: 0, left: 0 }}>
                  <XAxis dataKey="name"/>
                  <YAxis/>
                  <Tooltip formatter={(v)=>`₹ ${fmt1(v)} L`}/>
                  <Bar dataKey="value" fill="#6366F1">
                    <LabelList dataKey="value" position="top" formatter={(v)=>`${fmt1(v)} L`}/>
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Scenario Comparison */}
      <Card className="shadow-sm border">
        <CardContent className="p-4 space-y-3">
          <div className="flex items-center gap-2 mb-1"><Layers className="w-5 h-5"/><h2 className="text-xl font-medium">Scenario Compare (rounded to 1 decimal)</h2></div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b">
                  <th className="py-2">Scenario</th>
                  <th>Net Revenue (₹ L)</th>
                  <th>Expenses (₹ L)</th>
                  <th>Profit (₹ L)</th>
                  <th>Margin %</th>
                  <th>Breakeven</th>
                  <th>ROI %</th>
                  <th>IRR %</th>
                </tr>
              </thead>
              <tbody>
                {scenData.map((r, i) => (
                  <tr key={i} className="border-b">
                    <td className="py-2 font-medium">{r.Scenario}</td>
                    <td>{fmt1(r.Revenue)}</td>
                    <td>{fmt1(r.Expenses)}</td>
                    <td className={`${r.Profit>=0?"text-emerald-700":"text-red-600"}`}>{fmt1(r.Profit)}</td>
                    <td>{fmt1(r.Margin)}</td>
                    <td>{r.BE}</td>
                    <td>{fmt1(r.ROI)}</td>
                    <td>{fmt1(r.IRR)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </CardContent>
      </Card>

      <div className="text-xs text-muted-foreground">Note: All figures in ₹ Lakhs (1 decimal). 100 Lakhs = ₹1 Cr. Toggle the checkbox to scale fixed OPEX with scenario size if desired.</div>
    </div>
  );
}
